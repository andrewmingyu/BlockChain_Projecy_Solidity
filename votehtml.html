<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ì˜¨ì²´ì¸ íˆ¬í‘œ DApp</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; padding: 20px; max-width: 700px; margin: auto; }
    h1 { color: #333; }
    button { background-color: #007aff; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; margin-left: 10px; }
    button:hover { background-color: #0056b3; }
    #connectBtn { background-color: #f0ad4e; font-size: 16px; padding: 12px 20px; }
    #connectBtn:hover { background-color: #ec971f; }
    #candidates div { background-color: #f9f9f9; border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
    #status { font-family: "Courier New", Courier, monospace; background-color: #eee; padding: 10px; border-radius: 5px; word-wrap: break-word; }
  </style>
</head>
<body>

  <h1>ğŸ—³ï¸ ì˜¨ì²´ì¸ íˆ¬í‘œ DApp</h1>
  <button id="connectBtn" onclick="connectWallet()">ğŸ¦Š ë©”íƒ€ë§ˆìŠ¤í¬ ì—°ê²°</button>
  
  <hr>

  <h2>í›„ë³´ì ëª©ë¡</h2>
  <div id="candidates">
    <p>ì§€ê°‘ì„ ë¨¼ì € ì—°ê²°í•´ì£¼ì„¸ìš”...</p>
  </div>
  
  <h3>ìƒíƒœ ë©”ì‹œì§€</h3>
  <pre id="status">ëŒ€ê¸° ì¤‘...</pre>

  <script>
    // 1. ì‚¬ìš©ìë‹˜ì´ ì œê³µí•œ ì»¨íŠ¸ë™íŠ¸ ì£¼ì†Œ
    const contractAddress = "0xf89107c46eb32CF8A7a0880790c988F74B4fD048";

    // 2. ì‚¬ìš©ìë‹˜ì´ ì œê³µí•œ ABI (ëŒ€ê´„í˜¸ í•œ ê²¹ ì œê±°)
    const abi = [
        {
            "inputs": [
                {
                    "internalType": "uint256",
                    "name": "num",
                    "type": "uint256"
                }
            ],
            "name": "elect",
            "outputs": [],
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "inputs": [
                {
                    "internalType": "string[]",
                    "name": "names",
                    "type": "string[]"
                }
            ],
            "stateMutability": "nonpayable",
            "type": "constructor"
        },
        {
            "anonymous": false,
            "inputs": [
                {
                    "indexed": false,
                    "internalType": "address",
                    "name": "_address",
                    "type": "address"
                }
            ],
            "name": "voteNowAddress",
            "type": "event"
        },
        {
            "inputs": [],
            "name": "currentElect",
            "outputs": [
                {
                    "components": [
                        {
                            "internalType": "string",
                            "name": "name",
                            "type": "string"
                        },
                        {
                            "internalType": "uint256",
                            "name": "votenum",
                            "type": "uint256"
                        }
                    ],
                    "internalType": "struct Vote.Candidate[]",
                    "name": "",
                    "type": "tuple[]"
                }
            ],
            "stateMutability": "view",
            "type": "function"
        },
        {
            "inputs": [
                {
                    "internalType": "address",
                    "name": "",
                    "type": "address"
                }
            ],
            "name": "voters",
            "outputs": [
                {
                    "internalType": "bool",
                    "name": "",
                    "type": "bool"
                }
            ],
            "stateMutability": "view",
            "type": "function"
        }
    ];

    // Ethers.js ê°ì²´ë¥¼ ë‹´ì„ ì „ì—­ ë³€ìˆ˜
    let provider, signer, contract;
    const statusEl = document.getElementById("status");
    const candidatesEl = document.getElementById("candidates");
    const connectBtn = document.getElementById("connectBtn");

    // 3. ì§€ê°‘ ì—°ê²° í•¨ìˆ˜ (ìˆ˜ì •ë¨)
    async function connectWallet() {
      if (!window.ethereum) {
        alert("MetaMaskê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤! ğŸ¦Š");
        return;
      }
      
      try {
        statusEl.innerText = "ğŸ•’ ì§€ê°‘ ì—°ê²° ìš”ì²­ ì¤‘...";
        
        // Ethers.js v6 ë°©ì‹
        provider = new ethers.BrowserProvider(window.ethereum);
        
        // 1. ëª…ì‹œì ìœ¼ë¡œ ê³„ì • ì ‘ê·¼ì„ ìš”ì²­í•©ë‹ˆë‹¤. (ì´ ë¶€ë¶„ì´ ì¶”ê°€/ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤)
        await provider.send("eth_requestAccounts", []);
        
        // 2. ì„œëª…ì(signer)ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        signer = await provider.getSigner();
        
        // 3. ì»¨íŠ¸ë™íŠ¸ ê°ì²´ ìƒì„±
        contract = new ethers.Contract(contractAddress, abi, signer);
        
        const address = await signer.getAddress();
        statusEl.innerText = `âœ… ì§€ê°‘ ì—°ê²° ì™„ë£Œ!\nì£¼ì†Œ: ${address}`;
        connectBtn.innerText = "âœ… ì—°ê²°ë¨";
        connectBtn.disabled = true;

        // ì§€ê°‘ ì—°ê²° ì„±ê³µ ì‹œ í›„ë³´ì ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        loadCandidates();
      } catch (err) {
        console.error("ì§€ê°‘ ì—°ê²° ì‹¤íŒ¨:", err);
        // ì‚¬ìš©ì ê±°ë¶€, ê³„ì • ì—†ìŒ ë“± ë‹¤ì–‘í•œ ì˜¤ë¥˜ê°€ ì—¬ê¸°ì— ì¡í™ë‹ˆë‹¤.
        let friendlyMessage = err.message;
        if (err.code === 4001) {
            friendlyMessage = "ì‚¬ìš©ìê°€ ì—°ê²° ìš”ì²­ì„ ê±°ë¶€í–ˆìŠµë‹ˆë‹¤.";
        }
        statusEl.innerText = `âŒ ì§€ê°‘ ì—°ê²° ì‹¤íŒ¨: ${friendlyMessage}`; 
      }
    }

    // 4. í›„ë³´ì ëª©ë¡ ë¡œë“œ í•¨ìˆ˜ (currentElect í˜¸ì¶œ)
    async function loadCandidates() {
      if (!contract) return;
      
      statusEl.innerText = "ğŸ”„ í›„ë³´ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
      
      try {
        // ì»¨íŠ¸ë™íŠ¸ì˜ 'currentElect' view í•¨ìˆ˜ í˜¸ì¶œ
        const data = await contract.currentElect();
        
        candidatesEl.innerHTML = ""; // ê¸°ì¡´ ëª©ë¡ ë¹„ìš°ê¸°
        
        if (data.length === 0) {
            candidatesEl.innerHTML = "<p>ë“±ë¡ëœ í›„ë³´ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
            statusEl.innerText = "â„¹ï¸ í›„ë³´ì ëª©ë¡ì„ ë¶ˆëŸ¬ì™”ìœ¼ë‚˜, ë“±ë¡ëœ í›„ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.";
            return;
        }

        data.forEach((candidate, index) => {
          const div = document.createElement("div");
          // candidate ê°ì²´ëŠ” ABIì— ì •ì˜ëœ ëŒ€ë¡œ { name: 'ì´ë¦„', votenum: 0n } í˜•íƒœì…ë‹ˆë‹¤.
          // BigInt(0n)ë¥¼ ìˆ«ìë¡œ ë³€í™˜í•˜ê¸° ìœ„í•´ .toString() ì‚¬ìš©
          div.innerHTML = `
            <span><b>${candidate.name}</b> â€” ${candidate.votenum.toString()}í‘œ</span>
            <button onclick="vote(${index})">íˆ¬í‘œí•˜ê¸°</button>
          `;
          candidatesEl.appendChild(div);
        });

        statusEl.innerText = "âœ… í›„ë³´ì ëª©ë¡ ë¡œë“œ ì™„ë£Œ!";
      } catch (err) {
        console.error("í›„ë³´ì ë¡œë“œ ì˜¤ë¥˜:", err);
        statusEl.innerText = `âŒ í›„ë³´ì ë¡œë“œ ì˜¤ë¥˜: ${err.message}`;
      }
    }

    // 5. íˆ¬í‘œ í•¨ìˆ˜ (elect í˜¸ì¶œ)
    async function vote(index) {
      if (!contract) return alert("ì§€ê°‘ì„ ë¨¼ì € ì—°ê²°í•´ì£¼ì„¸ìš”.");

      try {
        statusEl.innerText = `ğŸ•’ ${index}ë²ˆ í›„ë³´ì—ê²Œ íˆ¬í‘œ íŠ¸ëœì­ì…˜ ì „ì†¡ ì¤‘...`;
        
        // ì»¨íŠ¸ë™íŠ¸ì˜ 'elect' ì“°ê¸° í•¨ìˆ˜ í˜¸ì¶œ
        const tx = await contract.elect(index);
        
        statusEl.innerText = "ğŸ”„ íŠ¸ëœì­ì…˜ì´ ì±„êµ´ë˜ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘... (1/1)";
        
        // íŠ¸ëœì­ì…˜ì´ ë¸”ë¡ì— í¬í•¨ë  ë•Œê¹Œì§€ ëŒ€ê¸°
        await tx.wait();
        
        statusEl.innerText = `âœ… ${index}ë²ˆ í›„ë³´ì—ê²Œ íˆ¬í‘œ ì™„ë£Œ! ğŸ—³ï¸\nìƒˆ ë“í‘œ í˜„í™©ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤...`;
        
        // íˆ¬í‘œ ì™„ë£Œ í›„ í›„ë³´ì ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        loadCandidates();
        
      } catch (err) {
        console.error("íˆ¬í‘œ ì˜¤ë¥˜:", err);
        // ì‚¬ìš©ìê°€ íŠ¸ëœì­ì…˜ì„ ê±°ë¶€í–ˆê±°ë‚˜, ì´ë¯¸ íˆ¬í‘œí•œ ê²½ìš°(voters í™•ì¸) ë“±
        let errorMessage = err.message;
        if (err.data?.message) {
            errorMessage = err.data.message;
        } else if (err.reason) {
            errorMessage = err.reason;
        }
        statusEl.innerText = `âŒ íˆ¬í‘œ ì˜¤ë¥˜ ë°œìƒ: ${errorMessage}`;
      }
    }
  </script>
</body>
</html>
